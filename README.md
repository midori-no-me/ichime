# Ichime

Нативное приложение для сайта Anime 365, созданное специально для Apple TV.

https://github.com/user-attachments/assets/15d83e16-49f2-4087-8c8d-1540761595de

Больше скриншотов можно найти на странице [Wiki → Скриншоты](https://github.com/midori-no-me/ichime/wiki/Скриншоты).

## Возможности приложения

Приложение покрывает все базовые сценарии пользования сайтом.

Просмотр серий:

- Все серии открываются в сторонних плеерах автоматически. На данный момент мы поддерживаем только [Infuse](https://apps.apple.com/app/id1136220934) и [VLC](https://apps.apple.com/app/id650377962). Эти плееры поддерживают субтитры в форматах ASS и SRT.
- Если досмотреть серию до конца, то она автоматически будет отмечена просмотренной. Так же, как это сделано на сайте.
- Выводим список следующих серий к просмотру так же, как на сайте они выводятся в секции "Серии к просмотру".

Каталог сериалов:

- Список онгоингов.
- Список тайтлов, сгруппированный по сезонам.
- Поиск.
- Показываем, когда выйдет следующая серия.
- Календарь онгоингов, который подтягивается из Shikimori.

Для получения информации о сериале мы используем разные источники, включая Shikimori и MyAnimeList (Jikan):

- Базовая информация о сериале, доступная на Anime 365.
- Название серий и их рейтинг.
- Моменты.
- Скриншоты сериала.
- Разные обложки.
- Список персонажей и сейю.
- Список авторов.
- Связанные сериалы (сиквелы, спин-оффы и т.п.).

Top Shelf:

- Если закрепить Ichime в верхнем ряду на домашнем экране Apple TV, то будем показывать в виджете секцию "Серии к просмотру" и расписание ближайших релизов.

## Как установить

Способы установки описаны на странице [Wiki → Как установить приложение](https://github.com/midori-no-me/ichime/wiki/Как-установить-приложение). Обратите внимание, что для установки приложения обязательно необходим компьютер на macOS.

Само приложение полностью бесплатное, но для просмотра сериалов на вашем аккаунте Anime 365 должна быть активна платная подписка.

## Поддерживается ли iOS или iPadOS?

Последняя версия, поддерживающая iOS и iPadOS, — это [1.7.7](https://github.com/midori-no-me/ichime/releases/tag/1.7.7). В новых версиях мы отказались от поддержки всех ОС в пользу tvOS. Подробнее об этом мы рассказали в заметках к релизу [1.8.0](https://github.com/midori-no-me/ichime/releases/tag/1.8.0), в рамках которого поддержка и была прекращена.

## Разработка приложения

### Как собрать приложение

Чтобы собрать приложение:

1. Склонируйте репозиторий.

2. Установите [XcodeGen](https://github.com/yonaskolb/XcodeGen).

3. В корне директории выполните команду:

   ```bash
   xcodegen generate
   ```

   Эта команда сгенерирует конфигурационные файлы для Xcode.

4. Откройте проект в Xcode.

5. Если необходимо подписать приложение, у всех таргетов во вкладке Signing & Capabilities выберите Team.

6. Соберите приложение через Xcode.

### Кодстайл и линтеры

Мы используем официальный форматтер кодстайла для Swift: [swift-format](https://github.com/swiftlang/swift-format). Убедитесь, что у вас Swift 6.0 или новее. Также мы используем [SwiftFormat](https://github.com/nicklockwood/SwiftFormat) и [SwiftLint](https://github.com/realm/SwiftLint).

Перед коммитом не забудьте запустить автоматическое исправление кодстайла:

```bash
make format
```

В качестве линтера мы используем только [Periphery](https://github.com/peripheryapp/periphery) — он позволяет находить мертвый код.

Линтеры можно запустить командой:

```bash
make lint
```

### Git Hooks

Запускать XcodeGen и команды для исправления кодстайда можно автоматически с помощью Git Hooks.

Установите хуки с помощью команды:

```bash
make hooks
```

### Релизы и автоматическая публикация в TestFlight

Приложение автоматически публикуется в TestFlight при создании git тега с версией.

#### Процесс создания релиза

1. **Убедитесь, что все изменения зафиксированы и код готов к релизу**

2. **Создайте релиз с помощью скрипта (рекомендуется):**
   ```bash
   ./scripts/release.sh 1.11.0
   ```
   
   **Или создайте git тег вручную:**
   ```bash
   git tag 1.11.0
   git push origin 1.11.0
   ```

3. **GitHub Actions автоматически:**
   - Соберет приложение для App Store
   - Автоматически увеличит build number
   - Загрузит билд в TestFlight
   - Создаст GitHub Release с описанием

#### Тестирование процесса сборки

Для тестирования без создания релиза используйте ручной запуск workflow:

1. Перейдите в [Actions → Deploy to TestFlight](../../actions/workflows/deploy.yml)
2. Нажмите "Run workflow"
3. Укажите версию для тестирования (например, `1.11.0-test`)
4. Включите "Test mode" чтобы пропустить загрузку в TestFlight

#### Настройка GitHub Secrets

Для работы автоматической публикации нужно настроить следующие secrets в Settings → Secrets and variables → Actions:

**Apple Developer:**
- `APPLE_API_KEY`: App Store Connect API ключ (.p8 файл в base64)
- `APPLE_API_KEY_ID`: Key ID из App Store Connect
- `APPLE_API_ISSUER_ID`: Issuer ID из App Store Connect

**Сертификаты и профили подписи:**
- `CERTIFICATES_P12`: Distribution сертификат (.p12 файл в base64)
- `CERTIFICATES_PASSWORD`: пароль от .p12 файла
- `PROVISIONING_PROFILE_ICHIME`: Provisioning profile для основного приложения (в base64)
- `PROVISIONING_PROFILE_TOPSHELF`: Provisioning profile для TopShelf расширения (в base64)

#### Получение base64 для файлов

```bash
# Для .p8 файла API ключа
base64 -i AuthKey_XXXXXXXXXX.p8

# Для .p12 сертификата  
base64 -i certificates.p12

# Для .mobileprovision файлов
base64 -i dev_midorinome_ichime.mobileprovision
base64 -i dev_midorinome_ichime_TopShelf.mobileprovision
```

#### Управление версиями

- **Marketing Version** (например, `1.11.0`) берется из git тега
- **Build Number** автоматически увеличивается: базовое значение (101000) + номер GitHub Actions run
- Версии автоматически обновляются в `project.yml` при сборке
- Приложение собирается и публикуется для **tvOS платформы**
