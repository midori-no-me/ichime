# Fastfile configuration for Ichime TestFlight deployment

default_platform(:ios)

platform :ios do
  desc "Upload to TestFlight"
  lane :deploy do |options|
    # Get version from parameters or environment
    version = options[:version] || ENV["VERSION"] || "1.0.0"
    build_number = options[:build_number] || ENV["BUILD_NUMBER"] || "1"

    setup_ci if ENV['CI']

    # Update project configuration
    update_project_version(version: version, build_number: build_number)

    # Explicitly specifying readonly to ensure CI behavior
    match(
      type: 'appstore',
      platform: 'tvos',
      readonly: is_ci,
      app_identifier: ["dev.midorinome.ichime", "dev.midorinome.ichime.TopShelf"]
    )

    # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º provisioning profiles –≤ Xcode –ø—Ä–æ–µ–∫—Ç–µ
    # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É https://github.com/fastlane/fastlane/issues/20165
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Ichime.xcodeproj",
      team_id: "YBBAN7R28K",
      code_sign_identity: "Apple Distribution",
      targets: ["Ichime_tvOS"],
      profile_name: "match AppStore dev.midorinome.ichime tvos"
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Ichime.xcodeproj",
      team_id: "YBBAN7R28K",
      code_sign_identity: "Apple Distribution",
      targets: ["TopShelf_tvOS"],
      profile_name: "match AppStore dev.midorinome.ichime.TopShelf tvos"
    )

    # Build the app
    build_app(
      workspace: "Ichime.xcodeproj/project.xcworkspace",
      scheme: "Ichime_tvOS",
      destination: "generic/platform=tvOS",
      clean: true,
      export_method: "app-store",
      include_bitcode: false,
      include_symbols: true,

      # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è CI
      codesigning_identity: "Apple Distribution",
      xcargs: "CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER='' -allowProvisioningUpdates",

      export_options: {
        method: "app-store",
        signingStyle: "manual",
        teamID: "YBBAN7R28K",
        provisioningProfiles: {
          "dev.midorinome.ichime" => "match AppStore dev.midorinome.ichime tvos",
          "dev.midorinome.ichime.TopShelf" => "match AppStore dev.midorinome.ichime.TopShelf tvos"
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      platform: "appletvos", # –£–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É tvOS
      distribute_external: true, # –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Ç–µ—Å—Ç–µ—Ä–æ–≤
      groups: ["External Testers", "Internal Testers"], # –ì—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      changelog: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ #{version} (build #{build_number})"
    )

    # Clean up
    clean_build_artifacts
  end

  desc "Test build without uploading"
  lane :test_build do |options|
    version = options[:version] || ENV["VERSION"] || "1.0.0-test"
    build_number = options[:build_number] || ENV["BUILD_NUMBER"] || "1"

    UI.message("üß™ Test build for version #{version} (build #{build_number})")

    setup_ci if ENV['CI']

    # Update project configuration
    update_project_version(version: version, build_number: build_number)

    match(
      type: 'appstore',
      platform: 'tvos',
      readonly: is_ci,
      app_identifier: ["dev.midorinome.ichime", "dev.midorinome.ichime.TopShelf"]
    )

    # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º provisioning profiles –≤ Xcode –ø—Ä–æ–µ–∫—Ç–µ
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Ichime.xcodeproj",
      team_id: "YBBAN7R28K",
      code_sign_identity: "Apple Distribution",
      targets: ["Ichime_tvOS"],
      profile_name: "match AppStore dev.midorinome.ichime tvos"
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Ichime.xcodeproj",
      team_id: "YBBAN7R28K",
      code_sign_identity: "Apple Distribution",
      targets: ["TopShelf_tvOS"],
      profile_name: "match AppStore dev.midorinome.ichime.TopShelf tvos"
    )

    # Build the app
    build_app(
      project: "Ichime.xcodeproj",
      scheme: "Ichime_tvOS",
      destination: "generic/platform=tvOS",
      archive_path: "./build/Ichime.xcarchive",
      export_method: "app-store",
      skip_package_ipa: false,

      # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è:
      codesigning_identity: "Apple Distribution",
      xcargs: "CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER='' -allowProvisioningUpdates",

      export_options: {
        method: "app-store",
        destination: "export",
        provisioningProfiles: {
          "dev.midorinome.ichime" => "match AppStore dev.midorinome.ichime tvos",
          "dev.midorinome.ichime.TopShelf" => "match AppStore dev.midorinome.ichime.TopShelf tvos"
        },
        signingStyle: "manual",
        teamID: "YBBAN7R28K"
      }
    )

    UI.success("‚úÖ Test build completed successfully!")
    UI.message("IPA saved to: #{lane_context[SharedValues::IPA_OUTPUT_PATH]}")
  end

  # Helper function to update version numbers
  private_lane :update_project_version do |options|
    version = options[:version]
    build_number = options[:build_number]

    UI.message("üìù Updating project version to #{version} (build #{build_number})")

    # Update project.yml
    sh("sed -i '' 's/MARKETING_VERSION: \".*\"/MARKETING_VERSION: \"#{version}\"/' ../project.yml")
    sh("sed -i '' 's/CURRENT_PROJECT_VERSION: [0-9]\\+/CURRENT_PROJECT_VERSION: #{build_number}/' ../project.yml")

    # Regenerate Xcode project after updating version in project.yml
    UI.message("üîÑ Regenerating Xcode project with updated version...")
    sh("cd .. && xcodegen generate")
  end
end
